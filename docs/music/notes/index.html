<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Notes · Gen.js</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;h2&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;playing-different-notes&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#playing-different-notes&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Playing Different Notes&lt;/h2&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Notes · Gen.js"/><meta property="og:type" content="website"/><meta property="og:url" content="https://meleyal.github.io/gen/"/><meta property="og:description" content="&lt;h2&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;playing-different-notes&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#playing-different-notes&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Playing Different Notes&lt;/h2&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/gen/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css"/><script type="text/javascript" src="/gen/js/custom.js"></script><script type="text/javascript" src="https://unpkg.com/@meleyal/gen/gen.js"></script><link rel="stylesheet" href="/gen/css/prism.css"/><link rel="stylesheet" href="/gen/css/main.css"/><script src="/gen/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/gen/"><h2 class="headerTitle">Gen.js</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/gen/docs/introduction" target="_self">Docs</a></li><li class=""><a href="https://github.com/meleyal/gen" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Music</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Welcome</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/introduction">Introduction</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Primers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/primers/generative">Generative</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/primers/music">Music</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/primers/javascript">JavaScript</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Music</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/gen/docs/music/notes">Notes</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/music/scales">Scales</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/music/timing">Timing</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/music/structure">Structure</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Generative</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/generative/repetition">Repetition</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/generative/randomness">Randomness</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/generative/probability">Probability</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/generative/grammars">Grammars</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/generative/recursion">Recursion</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/generative/evolution">Evolution</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/generative/machine-learning">Machine Learning</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/generative/sonification">Sonification</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Course</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/course/outline">Course Outline</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/api/">API Reference</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Notes</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="playing-different-notes"></a><a href="#playing-different-notes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Playing Different Notes</h2>
<p>Our musical options would be quite limited if we could only play middle C, so
let's explore ways to make other notes.</p>
<h3><a class="anchor" aria-hidden="true" id="pitch-shifting"></a><a href="#pitch-shifting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pitch Shifting</h3>
<p>One approach we could take is to adjust the pitch of our sample to emulate
different notes. Thanks to the intricacies of frequency and the human ear, we
perceive a sample played at twice the speed to be twice the pitch.</p>
<pre><code class="hljs css language-js"><span class="token comment">// Half speed = 22,050 Hz = -1 octave = C3</span>
<span class="token keyword">const</span> c3 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
c3<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer
c3<span class="token punctuation">.</span>playbackRate<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0.5</span>

<span class="token comment">// Full speed = 44,100 Hz = C4</span>
<span class="token keyword">const</span> c4 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
c4<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer
c4<span class="token punctuation">.</span>playbackRate<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1.0</span>

<span class="token comment">// Double speed = 88,200 Hz = +1 octave = C5</span>
<span class="token keyword">const</span> c5 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
c5<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer
c5<span class="token punctuation">.</span>playbackRate<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2.0</span>
</code></pre>
<p>This works surprisingly well within a limited range, but pitch shifting too much
can start to sound unnatural, especially for real instruments, where we have an
expectation of how they should sound at different pitches.</p>
<h3><a class="anchor" aria-hidden="true" id="samplers-and-sample-libraries"></a><a href="#samplers-and-sample-libraries" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Samplers and Sample Libraries</h3>
<p>A better approach, and one used in most music production, is to have a sample
for each note. This brings us to the topic of samplers and sample libraries.</p>
<p>A sampler, at its most basic, is an instrument that can load and play back
samples. You can assign samples to physical triggers such as the keys of a
keyboard, so that when pressing the key, the assigned sample is played.</p>
<p>Sample libraries (or sample packs) are bundles of samples, usually with a
metadata file that tells the sampler how the individual sample files map to
keyboard notes. A library maker records each individual note of an instrument,
often at various velocities (e.g. how hard a piano key is hit) and with
different techniques (e.g. whether a violin string is bowed or plucked) to
capture the full range of sounds the instrument can make. Whilst this can't
match the subtleties of how a musician might play, it's usually good enough for
composition.</p>
<blockquote>
<p><strong>Note:</strong> Sample libraries don't always contain recordings of all possible
notes, but combine a subset of samples with the pitch shifting trick mentioned
above.</p>
</blockquote>
<p>Most sample libraries are commercial products, often bundled with software
samplers, but there are several libraries available for free use. <strong>Gen.js</strong>
includes a range of samples for different instruments, which we'll be using
throughout this book. It includes a
<a href="https://github.com/meleyal/gen/tree/master/src/samples/piano">piano</a> sample
pack, which contains recordings of all the notes of a piano (A0–C8).</p>
<h3><a class="anchor" aria-hidden="true" id="sampler-v1"></a><a href="#sampler-v1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sampler v1</h3>
<p>We've already seen how we can load and play back a single sample. We can use the
same principles to load and play back an entire set of samples.</p>
<p>Let's create a <code>sampler()</code> function that takes an audio context and a map of
samples we want to load, and returns a function for playing them back:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">sampler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> samples</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> buffers <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>samples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token operator">=></span>
      <span class="token function">fetch</span><span class="token punctuation">(</span>samples<span class="token punctuation">[</span>note<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span> <span class="token operator">=></span> context<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> note<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token parameter">note</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">typeof</span> note <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token punctuation">[</span>note<span class="token punctuation">]</span> <span class="token punctuation">:</span> note
    <span class="token keyword">const</span> now <span class="token operator">=</span> context<span class="token punctuation">.</span>currentTime
    notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> buffer <span class="token operator">=</span> buffers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>note <span class="token operator">==</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span>buffer
      <span class="token keyword">const</span> sourceNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span>buffer <span class="token operator">=</span> buffer
      sourceNode<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> piano <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sampler</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token constant">C4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/samples/piano/c4.mp3'</span><span class="token punctuation">,</span>
    <span class="token constant">D4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/samples/piano/d4.mp3'</span><span class="token punctuation">,</span>
    <span class="token constant">E4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/samples/piano/e4.mp3'</span><span class="token punctuation">,</span>
    <span class="token constant">F4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/samples/piano/f4.mp3'</span><span class="token punctuation">,</span>
    <span class="token constant">G4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/samples/piano/g4.mp3'</span>
    <span class="token comment">// ...etc.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// Single C note</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token string">'C4'</span><span class="token punctuation">)</span>

  <span class="token comment">// C major chord</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'C4'</span><span class="token punctuation">,</span> <span class="token string">'E4'</span><span class="token punctuation">,</span> <span class="token string">'G4'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="mapping-notes-to-samples"></a><a href="#mapping-notes-to-samples" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mapping Notes to Samples</h2>
<p>Rather than writing out a sample map of 88 notes by hand, we can automate this
process with a <code>sampleMap()</code> function. But first, we'll need to understand a
small nuance of sample libraries.</p>
<h3><a class="anchor" aria-hidden="true" id="enharmonic-notes"></a><a href="#enharmonic-notes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enharmonic Notes</h3>
<p>If you inspect the piano samples, you might notice that they don't seem to
actually include <em>all</em> of the notes we need:</p>
<pre><code class="hljs css language-text">.
├── ...
├── c4.mp3
├── ... <- where is c#4.mp3?
├── db4.mp3
├── d4.mp3
├── ...
</code></pre>
<p>Recall from the <a href="../primers/music">Music</a> chapter that some notes can be sharp
(C#, half a semitone above C) or flat (Db, half a semitone below D). Looking at
our keyboard, we can see that these are actually the same note:</p>
<p><img src="/gen/docs/assets/sampler/enharmonic.svg" alt=""></p>
<p>These are known as &quot;enharmonic&quot; notes, which just means they are the same note
written in a different way. We can write a simple <code>enharmonic()</code> function to
convert in either direction:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">enharmonic</span> <span class="token operator">=</span> <span class="token parameter">note</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>note<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'A#'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'Bb'</span>
    <span class="token keyword">case</span> <span class="token string">'Bb'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'A#'</span>
    <span class="token keyword">case</span> <span class="token string">'C#'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'Db'</span>
    <span class="token keyword">case</span> <span class="token string">'Db'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'C#'</span>
    <span class="token keyword">case</span> <span class="token string">'D#'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'Eb'</span>
    <span class="token keyword">case</span> <span class="token string">'Eb'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'D#'</span>
    <span class="token keyword">case</span> <span class="token string">'F#'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'Gb'</span>
    <span class="token keyword">case</span> <span class="token string">'Gb'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'F#'</span>
    <span class="token keyword">case</span> <span class="token string">'G#'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'Ab'</span>
    <span class="token keyword">case</span> <span class="token string">'Ab'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'G#'</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> note
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">enharmonic</span><span class="token punctuation">(</span><span class="token string">'C#'</span><span class="token punctuation">)</span> <span class="token comment">// => Db</span>
<span class="token function">enharmonic</span><span class="token punctuation">(</span><span class="token string">'Db'</span><span class="token punctuation">)</span> <span class="token comment">// => C#</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="sample-map"></a><a href="#sample-map" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sample Map</h3>
<p>With our knowledge of enharmonics in hand, let's write a <code>sampleMap()</code> function
that maps the 88 note names to their respective sample files, taking into
account enharmonic naming (e.g. <code>C#4</code> maps to <code>db4.mp3</code>).</p>
<p>Different sample libraries may use different naming conventions and file
formats, so to account for that, our function will take a <code>pathFn</code> function to
construct the final url to the sample.</p>
<blockquote>
<p><strong>Note:</strong> Here we're mapping over all octaves and notes, but most instruments
have a more limited range than the piano. A fully-fledged <code>sampleMap()</code>
implementation might allow for specifying a given range to map over.</p>
</blockquote>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> enharmonic <span class="token punctuation">}</span> <span class="token operator">=</span> gen

<span class="token keyword">const</span> <span class="token function-variable function">sampleMap</span> <span class="token operator">=</span> <span class="token parameter">pathFn</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token string">'C,C#,D,D#,E,F,F#,G,G#,A,A#,B'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> octaves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>

  <span class="token keyword">return</span> notes
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token operator">=></span>
      octaves<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">octave</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>note<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>octave<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token function">pathFn</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> octave<span class="token punctuation">)</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> samples <span class="token operator">=</span> <span class="token function">sampleMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">note<span class="token punctuation">,</span> octave</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> baseUrl <span class="token operator">=</span> <span class="token string">'https://unpkg.com/@meleyal/gen'</span>
  <span class="token keyword">const</span> noteName <span class="token operator">=</span> <span class="token function">enharmonic</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/samples/piano/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>octave<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.mp3`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>samples<span class="token punctuation">)</span>

<span class="token comment">// Logs:</span>
<span class="token comment">//</span>
<span class="token comment">//  {</span>
<span class="token comment">//    A1: "http://localhost:3001/samples/piano/a1.mp3",</span>
<span class="token comment">//    A2: "http://localhost:3001/samples/piano/a2.mp3",</span>
<span class="token comment">//    A3: "http://localhost:3001/samples/piano/a3.mp3",</span>
<span class="token comment">//    A4: "http://localhost:3001/samples/piano/a4.mp3",</span>
<span class="token comment">//    A5: "http://localhost:3001/samples/piano/a5.mp3",</span>
<span class="token comment">//    ...etc.</span>
<span class="token comment">//  }</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="note-numbers"></a><a href="#note-numbers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Note Numbers</h3>
<p>When we get into generating notes and patterns later in the book, it will be
useful to be able to translate between note names and numbers. MIDI, which we
covered briefly in the <a href="../primers/music">Music</a> chapter, already has a
convention for note numbers, so we'll use that.</p>
<p>As we know, a piano keyboard has 88 keys spanning 7 octaves, going from A0 to
C8. MIDI note numbers go from 0 (C-1) to 127 (G9), which encompasses the full
range of notes produced by
<a href="https://en.wikipedia.org/wiki/Range_(music)">most instruments</a>.</p>
<p>Let's write two functions <code>noteNumber()</code> to get the MIDI note number given a
note name, and <code>noteName()</code> to get the the note name from the MIDI note number.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">noteNumber</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex">/(?&lt;note>\w(\w|\W)?)(?&lt;octave>\d{1})/u</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    groups<span class="token punctuation">:</span> <span class="token punctuation">{</span> note<span class="token punctuation">,</span> octave <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">C</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">'C#'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    Db<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token constant">D</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token string">'D#'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    Eb<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token constant">E</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token constant">F</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">'F#'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
    Gb<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token constant">G</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token string">'G#'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    Ab<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token constant">A</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
    <span class="token string">'A#'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    Bb<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token constant">B</span><span class="token punctuation">:</span> <span class="token number">11</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> notes<span class="token punctuation">[</span>note<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">+</span> <span class="token number">12</span> <span class="token operator">*</span> octave
<span class="token punctuation">}</span>

<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'C0'</span><span class="token punctuation">)</span> <span class="token comment">// => 12</span>
<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'C4'</span><span class="token punctuation">)</span> <span class="token comment">// => 60</span>
<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'Gb4'</span><span class="token punctuation">)</span> <span class="token comment">// => 66</span>
<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'G4'</span><span class="token punctuation">)</span> <span class="token comment">// => 67</span>
<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'A4'</span><span class="token punctuation">)</span> <span class="token comment">// => 69</span>
<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'A#4'</span><span class="token punctuation">)</span> <span class="token comment">// => 70</span>
<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'Bb4'</span><span class="token punctuation">)</span> <span class="token comment">// => 70</span>
<span class="token function">noteNumber</span><span class="token punctuation">(</span><span class="token string">'B4'</span><span class="token punctuation">)</span> <span class="token comment">// => 71</span>
</code></pre>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">noteName</span> <span class="token operator">=</span> <span class="token parameter">num</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'C'</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'C#/Db'</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'D'</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'D#/Eb'</span><span class="token punctuation">,</span>
    <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">'E'</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">'F'</span><span class="token punctuation">,</span>
    <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">'F#/Gb'</span><span class="token punctuation">,</span>
    <span class="token number">7</span><span class="token punctuation">:</span> <span class="token string">'G'</span><span class="token punctuation">,</span>
    <span class="token number">8</span><span class="token punctuation">:</span> <span class="token string">'G#/Ab'</span><span class="token punctuation">,</span>
    <span class="token number">9</span><span class="token punctuation">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span>
    <span class="token number">10</span><span class="token punctuation">:</span> <span class="token string">'A#/Bb'</span><span class="token punctuation">,</span>
    <span class="token number">11</span><span class="token punctuation">:</span> <span class="token string">'B'</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Normalize the note number so it maps to our 0-indexed `numbers` map.</span>
  <span class="token keyword">const</span> norm <span class="token operator">=</span> num <span class="token operator">-</span> <span class="token number">12</span>

  <span class="token comment">// Dividing the note number by 12 (the number of notes in an octave) gives us</span>
  <span class="token comment">// the octave that the note falls into.</span>
  <span class="token keyword">const</span> octave <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>norm <span class="token operator">/</span> <span class="token number">12</span><span class="token punctuation">)</span>

  <span class="token comment">// Remove the octaves to get a valid index into our numbers map.</span>
  <span class="token keyword">const</span> note <span class="token operator">=</span> norm <span class="token operator">-</span> <span class="token number">12</span> <span class="token operator">*</span> octave

  <span class="token keyword">return</span> numbers<span class="token punctuation">[</span>note<span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> name <span class="token operator">+</span> octave<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">noteName</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment">// => C0</span>
<span class="token function">noteName</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token comment">// => D0</span>
<span class="token function">noteName</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment">// => A0</span>
<span class="token function">noteName</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token comment">// => C1</span>
<span class="token function">noteName</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">// => C4</span>
<span class="token function">noteName</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span> <span class="token comment">// => G#5/Ab5</span>
<span class="token function">noteName</span><span class="token punctuation">(</span><span class="token number">107</span><span class="token punctuation">)</span> <span class="token comment">// => B7</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="sampler-v2"></a><a href="#sampler-v2" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sampler v2</h3>
<p>Putting this all together, we can combine our <code>sampleMap()</code> function with a
modified version of <code>sampler()</code> that can play notes given either a note name or
note number:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> noteName<span class="token punctuation">,</span> enharmonic<span class="token punctuation">,</span> sampleMap <span class="token punctuation">}</span> <span class="token operator">=</span> gen

<span class="token keyword">const</span> <span class="token function-variable function">sampler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> samples</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> buffers <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>samples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token operator">=></span>
      <span class="token function">fetch</span><span class="token punctuation">(</span>samples<span class="token punctuation">[</span>note<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span> <span class="token operator">=></span> context<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> note<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">parseNote</span> <span class="token operator">=</span> <span class="token parameter">note</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> note<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseNote<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> note <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token function">noteName</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>note<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token parameter">note</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token function">parseNote</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span>
    <span class="token keyword">const</span> now <span class="token operator">=</span> context<span class="token punctuation">.</span>currentTime
    notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> buffer <span class="token operator">=</span> buffers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>note <span class="token operator">==</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span>buffer
      <span class="token keyword">const</span> sourceNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span>buffer <span class="token operator">=</span> buffer
      sourceNode<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> samples <span class="token operator">=</span> <span class="token function">sampleMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">note<span class="token punctuation">,</span> octave</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> baseUrl <span class="token operator">=</span> <span class="token string">'https://unpkg.com/@meleyal/gen'</span>
    <span class="token keyword">const</span> noteName <span class="token operator">=</span> <span class="token function">enharmonic</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/samples/piano/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>octave<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.mp3`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> piano <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sampler</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> samples<span class="token punctuation">)</span>

  <span class="token comment">// Single C note</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token string">'C4'</span><span class="token punctuation">)</span>

  <span class="token comment">// C major chord</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'C4'</span><span class="token punctuation">,</span> <span class="token string">'E4'</span><span class="token punctuation">,</span> <span class="token string">'G4'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// Single C note</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>

  <span class="token comment">// C major chord</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="controlling-notes"></a><a href="#controlling-notes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Controlling Notes</h2>
<p>This is a good start, but our sampler is still missing a few essential features.</p>
<p>Currently, once triggered, our notes play at full volume from start to finish.
This is equivalent to playing a piano and pressing each key with the same
velocity and holding it for the same length of time.</p>
<p>To model how a real piano is played, where notes may be quiet, loud, short, or
long, we need a way to control our samples as they are playing.</p>
<h3><a class="anchor" aria-hidden="true" id="volume"></a><a href="#volume" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Volume</h3>
<p>We can control the volume of a sample with a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/GainNode"><code>GainNode</code></a>, which
changes the volume of any signal passing through it according to its
<code>gain.value</code>.</p>
<blockquote>
<p>We use gain and volume interchangeably here, but technically <em>gain</em> is the
change applied, resulting in a different <em>volume</em>.</p>
</blockquote>
<p>Returning back to our simple oscillator example, we can control its volume by
inserting a <code>GainNode</code> between it and our speakers.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> osc <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> volume <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

osc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>volume<span class="token punctuation">)</span>
volume<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>

volume<span class="token punctuation">.</span>gain<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0.5</span>
osc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="envelope"></a><a href="#envelope" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Envelope</h3>
<p>To control how long a note lasts, we can use what's known as an <em>envelope</em>. An
envelope controls how a sound evolves over time, and is broken down into four
phases:</p>
<ul>
<li>Attack: when a note is triggered, how long it takes to reach full volume.</li>
<li>Decay: how long it takes to drop to the sustain level.</li>
<li>Sustain: the constant volume after decay until a note is released.</li>
<li>Release: how quickly the sound fades after a note is released.</li>
</ul>
<p>These four phases define what's known as an <em>ADSR envelope</em>. For our purposes,
we can simplify this down to just the attack and release phases, which will
allow us to control how a sound peaks, and how long it lasts, known as an <em>AR
envelope</em>:</p>
<p><img src="/gen/docs/assets/notes/envelopes.svg" alt=""></p>
<p>Envelopes can be modelled with a <code>GainNode</code>, taking advantage of the fact that
its <code>gain</code> property is an
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioParam"><code>AudioParam</code></a> that
can be controlled over time:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> osc <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> envelope <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> now <span class="token operator">=</span> context<span class="token punctuation">.</span>currentTime
<span class="token keyword">const</span> zero <span class="token operator">=</span> <span class="token number">0.00001</span> <span class="token comment">// value must be positive for exponentialRamp</span>
<span class="token keyword">const</span> volume <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// full volume</span>
<span class="token keyword">const</span> attack <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// note takes 1 second to reach full volume</span>
<span class="token keyword">const</span> release <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// note lasts for 3 seconds</span>

envelope<span class="token punctuation">.</span>gain
  <span class="token punctuation">.</span><span class="token function">setValueAtTime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">linearRampToValueAtTime</span><span class="token punctuation">(</span>volume<span class="token punctuation">,</span> now <span class="token operator">+</span> attack<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">exponentialRampToValueAtTime</span><span class="token punctuation">(</span>zero<span class="token punctuation">,</span> now <span class="token operator">+</span> attack <span class="token operator">+</span> release<span class="token punctuation">)</span>

osc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>envelope<span class="token punctuation">)</span>
envelope<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
osc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="panning"></a><a href="#panning" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Panning</h3>
<p>Panning describes where a sound is placed in the stereo field, and emulates the
effect of sounds coming from different physical spaces. When mixing different
sounds together, panning can give each sound it's own place in the mix.</p>
<p>For our purposes, we're only working with two audio channels: left and right.
Panning essentially just controls how &quot;much&quot; of a sound goes to each channel.</p>
<p>To pan sounds we can use a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/StereoPannerNode"><code>StereoPannerNode</code></a>.
Setting its <code>pan.value</code> determines where the sound is panned, ranging from <code>-1</code>
being fully left, <code>0</code> being centre, to <code>1</code> being fully right.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> osc <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> panner <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createStereoPanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

panner<span class="token punctuation">.</span>pan<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// fully left</span>

osc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>panner<span class="token punctuation">)</span>
panner<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
osc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="compression"></a><a href="#compression" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compression</h3>
<p>Compression, in simple terms, is the process of modifying, or <em>limiting</em>, the
quietness and/or loudness of a sound signal.</p>
<p>When combining multiple sounds, their volumes (or <em>amplitudes</em>) are added
together, which can result in distortion if their combined amplitudes exceed the
range of our speakers. By running our audio signal through a compressor, we can
ensure that the resulting signal never exceeds or drops below a given threshold.</p>
<p>The example below shows combining two oscillators without compression. If you
turn up your volume, you should notice that the sound starts to distort at some
point:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> osc1 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> osc2 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

osc1<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">440</span>
osc2<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">880</span>

osc1<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
osc2<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>

osc1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
osc2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Compare this with the example below where we run both oscillators through a
compressor. Even when increasing the volume to maximum, there should be no
distortion:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> now <span class="token operator">=</span> context<span class="token punctuation">.</span>currentTime

<span class="token keyword">const</span> osc1 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> osc2 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> compressor <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createDynamicsCompressor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

osc1<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">440</span>
osc2<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">880</span>

compressor<span class="token punctuation">.</span>threshold<span class="token punctuation">.</span><span class="token function">setValueAtTime</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>
compressor<span class="token punctuation">.</span>knee<span class="token punctuation">.</span><span class="token function">setValueAtTime</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>
compressor<span class="token punctuation">.</span>ratio<span class="token punctuation">.</span><span class="token function">setValueAtTime</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>
compressor<span class="token punctuation">.</span>attack<span class="token punctuation">.</span><span class="token function">setValueAtTime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>
compressor<span class="token punctuation">.</span>release<span class="token punctuation">.</span><span class="token function">setValueAtTime</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>

osc1<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>compressor<span class="token punctuation">)</span>
osc2<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>compressor<span class="token punctuation">)</span>
compressor<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>

osc1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
osc2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="reverb"></a><a href="#reverb" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reverb</h3>
<p>TODO: Impulse responses.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> reverbNode <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createReverb</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> context<span class="token punctuation">.</span>destination<span class="token punctuation">,</span> reverb<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">createReverb</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> output<span class="token punctuation">,</span> impulse</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> impulseBuffer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadImpulse</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> reverbSamples<span class="token punctuation">[</span>impulse<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> convolverNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createConvolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  convolverNode<span class="token punctuation">.</span>buffer <span class="token operator">=</span> impulseBuffer<span class="token punctuation">.</span>buffer
  convolverNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
  <span class="token keyword">return</span> convolverNode
<span class="token punctuation">}</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="sampler-v3"></a><a href="#sampler-v3" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sampler v3</h3>
<p>Putting all of these concepts together, we can build a sampler.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">sampler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> samples</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> buffers <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>samples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token operator">=></span>
      <span class="token function">fetch</span><span class="token punctuation">(</span>samples<span class="token punctuation">[</span>note<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span> <span class="token operator">=></span> context<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> note<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> compressorNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createDynamicsCompressor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  compressorNode<span class="token punctuation">.</span>threshold<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">50</span>
  compressorNode<span class="token punctuation">.</span>knee<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">40</span>
  compressorNode<span class="token punctuation">.</span>ratio<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">12</span>
  compressorNode<span class="token punctuation">.</span>attack<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span>
  compressorNode<span class="token punctuation">.</span>release<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0.25</span>

  <span class="token keyword">const</span> gainNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">note<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> now <span class="token operator">=</span> context<span class="token punctuation">.</span>currentTime
    <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">typeof</span> note <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token punctuation">[</span>note<span class="token punctuation">]</span> <span class="token punctuation">:</span> note
    <span class="token keyword">const</span> defaults <span class="token operator">=</span> <span class="token punctuation">{</span> volume<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> duration<span class="token punctuation">:</span> <span class="token number">Infinity</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> volume<span class="token punctuation">,</span> duration <span class="token punctuation">}</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>defaults<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

    notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> buffer <span class="token operator">=</span> buffers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>note <span class="token operator">==</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span>buffer
      <span class="token keyword">const</span> sourceNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span>buffer <span class="token operator">=</span> buffer
      sourceNode<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> zero <span class="token operator">=</span> <span class="token number">0.00001</span> <span class="token comment">// value must be positive for exponentialRamp</span>
      gainNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span>value <span class="token operator">=</span> volume
      gainNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span><span class="token function">exponentialRampToValueAtTime</span><span class="token punctuation">(</span>
        zero<span class="token punctuation">,</span>
        now <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>duration<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>

      sourceNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>gainNode<span class="token punctuation">)</span>
      gainNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>compressorNode<span class="token punctuation">)</span>
      compressorNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

gen<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">context</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> piano <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sampler</span><span class="token punctuation">(</span>
    context<span class="token punctuation">,</span>
    gen<span class="token punctuation">.</span><span class="token function">sampleMap</span><span class="token punctuation">(</span><span class="token string">'https://unpkg.com/@meleyal/gen/samples/piano/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// Single C note</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token string">'C4'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> volume<span class="token punctuation">:</span> <span class="token number">0.5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// C major chord</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'C4'</span><span class="token punctuation">,</span> <span class="token string">'E4'</span><span class="token punctuation">,</span> <span class="token string">'G4'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> volume<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span> duration<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="learning"></a><a href="#learning" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Learning</h2>
<p>TODO: Mention that these functions are part of <code>gen</code>, and we'll use them going
forward.</p>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 7/27/2019</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/gen/docs/primers/javascript"><span class="arrow-prev">← </span><span class="function-name-prevnext">JavaScript</span></a><a class="docs-next button" href="/gen/docs/music/scales"><span>Scales</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#playing-different-notes">Playing Different Notes</a><ul class="toc-headings"><li><a href="#pitch-shifting">Pitch Shifting</a></li><li><a href="#samplers-and-sample-libraries">Samplers and Sample Libraries</a></li><li><a href="#sampler-v1">Sampler v1</a></li></ul></li><li><a href="#mapping-notes-to-samples">Mapping Notes to Samples</a><ul class="toc-headings"><li><a href="#enharmonic-notes">Enharmonic Notes</a></li><li><a href="#sample-map">Sample Map</a></li><li><a href="#note-numbers">Note Numbers</a></li><li><a href="#sampler-v2">Sampler v2</a></li></ul></li><li><a href="#controlling-notes">Controlling Notes</a><ul class="toc-headings"><li><a href="#volume">Volume</a></li><li><a href="#envelope">Envelope</a></li><li><a href="#panning">Panning</a></li><li><a href="#compression">Compression</a></li><li><a href="#reverb">Reverb</a></li><li><a href="#sampler-v3">Sampler v3</a></li></ul></li><li><a href="#learning">Learning</a></li></ul></nav></div></div></body></html>