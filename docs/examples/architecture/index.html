<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Architecture · Gen.js</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;This chapter focuses on how to structure our programs. The goal is to provide&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Architecture · Gen.js"/><meta property="og:type" content="website"/><meta property="og:url" content="https://meleyal.github.io/gen/"/><meta property="og:description" content="&lt;p&gt;This chapter focuses on how to structure our programs. The goal is to provide&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/gen/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css"/><script type="text/javascript" src="/gen/js/custom.js"></script><script type="text/javascript" src="https://unpkg.com/@meleyal/gen/gen.js"></script><link rel="stylesheet" href="/gen/css/prism.css"/><link rel="stylesheet" href="/gen/css/main.css"/><script src="/gen/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/gen/"><h2 class="headerTitle">Gen.js</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/gen/docs/introduction" target="_self">Docs</a></li><li class=""><a href="https://github.com/meleyal/gen" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Architecture</h1></header><article><div><span><p>This chapter focuses on how to structure our programs. The goal is to provide
some minimal conventions for where to put things, so we can focus on the
interesting parts of our program.</p>
<p>This is not essential, you can certainly structure your program any way that
makes sense to you. What's offered here is one way to do it. Even if you don't
adopt this pattern, it's worth skimming this chapter as the later examples in
the book use it.</p>
<p>The architecture presented here is based on the concept of &quot;one-way data flow&quot;,
and is borrowed from
<a href="https://guide.elm-lang.org/architecture/">The Elm Architecture</a>. A <code>program</code>
generates <code>messages</code> which are sent to an <code>update</code> function that updates a data
<code>model</code> and passes it to a <code>render</code> function. It's as simple as that!</p>
<p><img src="/gen/docs/assets/architecture/one-way-data-flow.svg" alt=""></p>
<h2><a class="anchor" aria-hidden="true" id="model"></a><a href="#model" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Model</h2>
<p>The <code>model</code> is an object that describes the state of our program. Here, we can
think about the &quot;shape&quot; of the data that our program will need. We can fill in
known values, and provide placeholders for data we need to wait for (e.g.
samples being loaded).</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token punctuation">{</span>
  tick<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  bpm<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
  samples<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="messages"></a><a href="#messages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Messages</h2>
<p>The <code>messages()</code> function describes all the things we want to happen in our
program. It receives the current <code>model</code>, and a <code>send()</code> function it can use to
update the model. It returns an object describing the things we want to happen
in our program.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">messages</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> send</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">tick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tick<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Messages can optionally call other messages:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">messages</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> send</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> msgs <span class="token operator">=</span>  <span class="token punctuation">{</span>
    <span class="token function-variable function">tick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token punctuation">{</span> tick<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>msgs<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function-variable function">hello</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> hello<span class="token punctuation">:</span> <span class="token string">'world'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> msgs
<span class="token punctuation">}</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="update"></a><a href="#update" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update</h2>
<p>If your update logic is more complicated, you can provide a custom <code>update()</code>
function to <code>program()</code>.</p>
<p>The <code>update()</code> function receives the current <code>model</code>, and a message (or
&quot;action&quot;) (<code>msg</code>). It updates the model according to the message type and
returns it. While not enforced, you should think of the model as immutable. Each
time we update it we get back a new version or &quot;snapshot&quot; of the current model.
The benefits of immutable model will become more apparent later in the book.</p>
<p>The default implementation just merges the message into the model using the key
and value of the <code>msg</code>.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>model<span class="token punctuation">,</span>
    <span class="token operator">...</span>msg
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tick<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> tick<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// => { tick: 1 }</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="render"></a><a href="#render" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Render</h2>
<p>The <code>render()</code> function is where we actually make sounds. It takes our model as
input, and the result is something that outputs audio to our speakers.</p>
<blockquote>
<p>TODO: Example</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="program"></a><a href="#program" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Program</h2>
<p>These functions don't currently talk to each other, we still need a way to wire
them together.</p>
<p>The <code>program()</code> function takes care of calling <code>init()</code> to build the initial
model, sends <code>messages()</code> to <code>update()</code> our model, and automatically calls
<code>render()</code> with the updated model, forming a continuous feedback loop.</p>
<p>This example shows how to setup a metronome to continually update the model with
the current beat.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> program<span class="token punctuation">,</span> metronome<span class="token punctuation">,</span> resolution <span class="token punctuation">}</span> <span class="token operator">=</span> gen

<span class="token comment">// -- MODEL</span>

<span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token punctuation">{</span>
  tick<span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// -- MESSAGES</span>

<span class="token keyword">const</span> <span class="token function-variable function">messages</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> send</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> context <span class="token punctuation">}</span> <span class="token operator">=</span> model

  <span class="token function-variable function">tick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> metro <span class="token operator">=</span> <span class="token function">resolution</span><span class="token punctuation">(</span><span class="token function">metronome</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

    metro<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">tick</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tick <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// -- RENDER</span>

<span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">model</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span>tick<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// -- PROGRAM</span>

<span class="token function">program</span><span class="token punctuation">(</span><span class="token punctuation">{</span> model<span class="token punctuation">,</span> messages<span class="token punctuation">,</span> render <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 7/27/2019</em></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#model">Model</a></li><li><a href="#messages">Messages</a></li><li><a href="#update">Update</a></li><li><a href="#render">Render</a></li><li><a href="#program">Program</a></li></ul></nav></div></div></body></html>