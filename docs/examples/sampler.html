<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Sampler · Gen.js</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;An obvious place to start is to understand how to create musical notes. This&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Sampler · Gen.js"/><meta property="og:type" content="website"/><meta property="og:url" content="https://meleyal.github.io/gen/"/><meta property="og:description" content="&lt;p&gt;An obvious place to start is to understand how to create musical notes. This&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/gen/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css"/><script type="text/javascript" src="/gen/js/custom.js"></script><link rel="stylesheet" href="/gen/css/prism.css"/><link rel="stylesheet" href="/gen/css/main.css"/><script src="/gen/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/gen/"><h2 class="headerTitle">Gen.js</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/gen/docs/introduction" target="_self">Docs</a></li><li class="siteNavGroupActive"><a href="/gen/docs/api/" target="_self">API</a></li><li class=""><a href="https://github.com/meleyal/gen" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Examples</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Welcome</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/introduction">Introduction</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Primers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/primers/generative">Generative</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/primers/music">Music</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/primers/javascript">JavaScript</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Examples</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/gen/docs/examples/sampler">Sampler</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/examples/metronome">Metronome</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/examples/sequencer">Sequencer</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/examples/walker">Walker</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/api/">API Reference</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Appendix</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/appendix/links">Links</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/appendix/forms">Forms</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Sampler</h1></header><article><div><span><p>An obvious place to start is to understand how to create musical notes. This
example covers how to generate notes, first using synthesis, then using samples,
before building a general purpose sampler we can use to load and play back a
whole set of sampled notes.</p>
<h2><a class="anchor" aria-hidden="true" id="single-note"></a><a href="#single-note" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Single note</h2>
<h3><a class="anchor" aria-hidden="true" id="synthesised"></a><a href="#synthesised" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Synthesised</h3>
<p>The Web Audio API provides all the building blocks required to synthesise your
own sounds by combining oscillators and effects. The easiest way to hear some
noise is to create an
<a href="https://developer.mozilla.org/en-US/docs/Web/API/OscillatorNode"><code>OscillatorNode</code></a>.</p>
<p>An oscillator can be tuned to (or oscillate at) a specific frequency. Musical
notes are basically just the names we've given to certain frequencies. If we
know the frequency of a note, we can set the oscillator to that frequency and it
will produce that note.</p>
<p>Here, we set the oscillator to 440 Hz, which is the frequency of the middle C
(C4) note on a piano. The default oscillator type is <code>sine</code>, so when running
this code we hear a pure sine wave tone at middle C.</p>
<pre><code class="hljs css language-js"><span class="token comment">// Create our global AudioContext</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Create an OscillatorNode</span>
<span class="token keyword">const</span> osc <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Set its frequency to 440 Hz = middle C</span>
osc<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">440</span>

<span class="token comment">// Connect it to the default destination (our speakers)</span>
osc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>

<span class="token comment">// Start (play) the oscillator</span>
osc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Sound synthesis is its own rich topic. With it you can generate an infinite
range of sounds. As mentioned in the introduction, however, it's not the focus
of this book, so we won't delve much deeper here.</p>
<h3><a class="anchor" aria-hidden="true" id="sampled"></a><a href="#sampled" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sampled</h3>
<p>Our focus is music composition, so rather than synthesising our own sounds,
we're instead going to delegate that work to pre-recorded instrument samples.</p>
<p>To play back samples we need a few elements:</p>
<ul>
<li>A sample audio file: e.g.
<a href="https://unpkg.com/@meleyal/gen/src/samples/piano/c4.mp3">the middle C (C4) note played on a piano</a></li>
<li>A way to load the audio file:
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API"><code>fetch</code></a></li>
<li>A way to decode the audio file for playback:
<a href="https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/decodeAudioData"><code>decodeAudioData</code></a></li>
<li>A place to store the decoded audio:
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer"><code>AudioBuffer</code></a></li>
<li>A way to play back the decoded audio:
<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode"><code>AudioBufferSourceNode</code></a></li>
</ul>
<p>With these, we can create something equivalent to the synthesised example above,
but this time using our pre-recorded sample. When running this code, we hear our
piano sample play from start to finish.</p>
<pre><code class="hljs css language-js"><span class="token comment">// Create our global AudioContext</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Fetch the sample from the server (the file must be hosted somewhere)</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://unpkg.com/@meleyal/gen/src/samples/piano/c4.mp3'</span><span class="token punctuation">)</span>
  <span class="token comment">// Get the arrayBuffer representation of the file from the response</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span> <span class="token operator">=></span>
    <span class="token comment">// Decode the arrayBuffer into an audioBuffer</span>
    context<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">audioBuffer</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Create an AudioBufferSourceNode</span>
      <span class="token keyword">const</span> sourceNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment">// Set its buffer property to our returned audioBuffer</span>
      sourceNode<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer

      <span class="token comment">// Connect it to the default destination (our speakers)</span>
      sourceNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>

      <span class="token comment">// Start (play) the sample</span>
      sourceNode<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="different-notes"></a><a href="#different-notes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Different notes</h2>
<p>Our musical options would be quite limited if we could only play middle C, so
let's explore ways to make other notes.</p>
<h3><a class="anchor" aria-hidden="true" id="pitch-shifting"></a><a href="#pitch-shifting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pitch shifting</h3>
<p>One approach we could take is to adjust the pitch of our sample to emulate
different notes. Thanks to the intricacies of frequency and the human ear, we
perceive a sample played at twice the speed to be twice the pitch.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://unpkg.com/@meleyal/gen/src/samples/piano/c4.mp3'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span> <span class="token operator">=></span>
    context<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">audioBuffer</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Half speed = 22,050 Hz = -1 octave = C3</span>
      <span class="token keyword">const</span> c3 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      c3<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer
      c3<span class="token punctuation">.</span>playbackRate<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0.5</span>

      <span class="token comment">// Full speed = 44,100 Hz = C4</span>
      <span class="token keyword">const</span> c4 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      c4<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer
      c4<span class="token punctuation">.</span>playbackRate<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1.0</span>

      <span class="token comment">// Double speed = 88,200 Hz = +1 octave = C5</span>
      <span class="token keyword">const</span> c5 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      c5<span class="token punctuation">.</span>buffer <span class="token operator">=</span> audioBuffer
      c5<span class="token punctuation">.</span>playbackRate<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2.0</span>

      c3<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
      c4<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
      c5<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>

      c3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      c4<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      c5<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre>
<p>This works surprisingly well within a limited range, but pitch shifting too much
can start to sound unnatural, especially for real instruments, where we have an
expectation of how they should sound at different pitches.</p>
<h3><a class="anchor" aria-hidden="true" id="samplers-sample-libraries"></a><a href="#samplers-sample-libraries" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Samplers &amp; sample libraries</h3>
<p>A sampler, in it's basic form, is an instrument that can load and play back
samples. You can assign samples to physical triggers such as the keys of a
keyboard, so that when hitting the key, the assigned sample is played.</p>
<p>Sample libraries (or sample packs) are just bundles of samples, usually with a
metadata file that tells the sampler how the individual sample files map to
keyboard notes. A library maker records each individual note of an instrument,
often at various velocities (e.g. how hard a piano key is hit) and with
different techniques (e.g. whether a violin string is bowed or plucked) to
capture the full range of sounds the instrument can make. Whilst this can't
match the subtleties of how a musician might play, it's usually good enough for
composition.</p>
<blockquote>
<p>Many sample libraries don't contain recordings of all possible notes, but
combine a subset of samples with the pitch shifting trick mentioned above.</p>
</blockquote>
<p>Most sample libraries are commercial products, often bundled with software
samplers, but there are a range libraries available for free use. See the
<a href="../appendix/links">appendix</a> for details.</p>
<h3><a class="anchor" aria-hidden="true" id="sampler-v1"></a><a href="#sampler-v1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sampler V1</h3>
<p>We've already seen how we can load and play back a single sample. We can use the
same principles to load and play back an entire set of samples. For this
example, we're using the
<a href="https://freesound.org/people/neatonk/packs/9133/">MISStereoPiano</a> sample pack
from Freesound, which contains all the notes from A0–C8.</p>
<blockquote>
<p><a href="https://www.npmjs.com/settings/meleyal/packages">Gen.js</a> includes a range of
samples for different instruments, including the MISStereoPiano pack. We're
using <a href="https://unpkg.com/">unpkg.com</a> as a convenient way to serve the files
from the npm package.</p>
</blockquote>
<p>Let's create a <code>sampler</code> function that takes a map of samples we want to load,
and returns a function for playing them back:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">sampler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> samples</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> buffers <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>samples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token operator">=></span>
      <span class="token function">fetch</span><span class="token punctuation">(</span>samples<span class="token punctuation">[</span>note<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span> <span class="token operator">=></span> context<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> note<span class="token punctuation">,</span> buffer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token parameter">note</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">typeof</span> note <span class="token operator">==</span> <span class="token string">'String'</span> <span class="token operator">?</span> <span class="token punctuation">[</span>note<span class="token punctuation">]</span> <span class="token punctuation">:</span> note
    <span class="token keyword">const</span> now <span class="token operator">=</span> context<span class="token punctuation">.</span>currentTime
    notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> buffer <span class="token operator">=</span> buffers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>note <span class="token operator">==</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span>buffer
      <span class="token keyword">const</span> sourceNode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createBufferSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span>buffer <span class="token operator">=</span> buffer
      sourceNode<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span>now <span class="token operator">+</span> buffer<span class="token punctuation">.</span>duration<span class="token punctuation">)</span>
      sourceNode<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> piano <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sampler</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token constant">C4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/src/samples/piano/c4.mp3'</span><span class="token punctuation">,</span>
    <span class="token constant">E4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/src/samples/piano/e4.mp3'</span><span class="token punctuation">,</span>
    <span class="token constant">G4</span><span class="token punctuation">:</span> <span class="token string">'https://unpkg.com/@meleyal/gen/src/samples/piano/g4.mp3'</span>
    <span class="token comment">// ...etc.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// C major chord</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token string">'C4'</span><span class="token punctuation">)</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token string">'E4'</span><span class="token punctuation">)</span>
  <span class="token function">piano</span><span class="token punctuation">(</span><span class="token string">'G4'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="enharmonic-notes"></a><a href="#enharmonic-notes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enharmonic notes</h3>
<p>If you inspect the sample pack, you might notice that it doesn't seem to
actually contain <em>all</em> of the notes we need:</p>
<pre><code class="hljs css language-text">.
├── ...
├── c4.mp3
├── ... <- where is c#4.mp3?
├── db4.mp3
├── d4.mp3
├── ...
</code></pre>
<p>Recall from the <a href="../primers/music">Music</a> chapter that some notes can be sharp
(C#, half a semitone above C) or flat (Db, half a semitone below D). Looking at
our keyboard, we can see that these are actually the same note:</p>
<p><img src="/gen/docs/assets/sampler/enharmonic.png" alt=""></p>
<p>These are known as &quot;enharmonic&quot; notes, which just means they are the same note
written in a different way.</p>
<p>We need a way to teach our sampler this, so let's write a <code>sampleMap()</code> function
that takes care of mapping the 86 note names to their respective sample files,
taking into account enharmonic naming (i.e. <code>C#4</code> maps to <code>db4.mp3</code>).</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> <span class="token function-variable function">sampleMap</span> <span class="token operator">=</span> <span class="token parameter">baseUrl</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token string">'C,C#,D,D#,E,F,F#,G,G#,A,A#,B'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> octaves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> extension <span class="token operator">=</span> <span class="token string">'.mp3'</span>

  <span class="token keyword">const</span> <span class="token function-variable function">enharmonic</span> <span class="token operator">=</span> <span class="token parameter">note</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>note<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'A#'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'bb'</span>
      <span class="token keyword">case</span> <span class="token string">'C#'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'db'</span>
      <span class="token keyword">case</span> <span class="token string">'D#'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'eb'</span>
      <span class="token keyword">case</span> <span class="token string">'F#'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'bb'</span>
      <span class="token keyword">case</span> <span class="token string">'G#'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'ab'</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> note
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> notes
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token operator">=></span>
      octaves<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">octave</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>note<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>octave<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
        <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">enharmonic</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>octave<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extension<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">:</span> path <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sampleMap</span><span class="token punctuation">(</span><span class="token string">'https://unpkg.com/@meleyal/gen/src/samples/piano/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>With these functions, we can express our sampler quite concisely:</p>
<pre><code class="hljs css language-js"></code></pre>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 5/8/2019</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/gen/docs/primers/javascript"><span class="arrow-prev">← </span><span class="function-name-prevnext">JavaScript</span></a><a class="docs-next button" href="/gen/docs/examples/metronome"><span>Metronome</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#single-note">Single note</a><ul class="toc-headings"><li><a href="#synthesised">Synthesised</a></li><li><a href="#sampled">Sampled</a></li></ul></li><li><a href="#different-notes">Different notes</a><ul class="toc-headings"><li><a href="#pitch-shifting">Pitch shifting</a></li><li><a href="#samplers-sample-libraries">Samplers &amp; sample libraries</a></li><li><a href="#sampler-v1">Sampler V1</a></li><li><a href="#enharmonic-notes">Enharmonic notes</a></li></ul></li></ul></nav></div></div></body></html>